// schema.prisma
generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("user")
  createdAt DateTime @default(now())
  
  conversations Conversation[]
  messages      Message[]
  
  @@map("users")
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  userId         String?  // CHO PHÉP NULL
  role           String
  content        String
  tokens         Int?
  intent         String?
  category       String?
  sentiment      String?
  confidence     Float?
  embedding      String?
  isTrainingExample Boolean @default(false)
  source         String
  metadata       Json?
  createdAt      DateTime @default(now())

  // SỬA QUAN HỆ - THÊM onDelete: SetNull
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  
  @@index([conversationId])
  @@index([userId])
  @@index([intent])
  @@index([category])
  @@index([isTrainingExample])
  @@index([createdAt])
  @@map("messages")
}

model Conversation {
  id             String   @id @default(uuid())
  title          String?
  userId         String?
  // SỬA QUAN HỆ
  user           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  usedInTraining Boolean  @default(false)
  trainingScore  Float?
  tags           String[]
  metadata       Json?
  createdAt      DateTime @default(now())
  messages       Message[]
  
  @@index([userId])
  @@index([usedInTraining])
  @@index([createdAt])
  @@map("conversations")
}
model Response {
  id        String   @id @default(uuid())
  hash      String   @unique
  content   String
  usage     Json?
  createdAt DateTime @default(now())
  
  @@map("responses")
}

model PromptHash {
  id               String   @id @default(uuid())
  promptHash       String
  responseId       String?
  normalizedPrompt String?
  createdAt        DateTime @default(now())
  
  @@map("prompt_hashes")
}


model ExampleQA {
  id          String   @id @default(uuid())
  question    String   // Câu hỏi mẫu
  answer      String   // Câu trả lời mẫu
  intent      String?  // Mục đích của câu hỏi
  category    String?  // Danh mục/chủ đề
  language    String   @default("vi") // Ngôn ngữ
  isActive    Boolean  @default(true) // Có đang được sử dụng không
  tags        String[] // Tags để filter/tìm kiếm
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  ownerEmail  String?

  @@index([intent])
  @@index([category])
  @@index([language])
  @@index([isActive])
  @@index([createdAt])
  @@index([ownerEmail])
  @@map("example_qa")
}

model Product {
  id          String   @id @default(uuid())
  name        String
  slug        String?  @unique
  description String?
  price       Float    @default(0)
  weight      Float?
  length           Float?    // cm
  width            Float?    // cm  
  height           Float?    // cm
  category    String?
  brand       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  ownerEmail  String?

  @@index([name])
  @@index([category])
  @@index([brand])
  @@index([price])
  @@index([isActive])
  @@index([createdAt])
  @@index([ownerEmail])
  @@map("products")
}

model KeywordPrompt {
  id          Int      @id @default(autoincrement())
  keyword     String   @db.VarChar(255) 
  prompt      String   @db.Text 
  sampleAnswer String  @db.Text 
  additionalInfo String? @db.Text 
  priority    Int      @default(0) 
  ownerEmail  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([keyword])
  @@index([ownerEmail])
  @@index([priority])
  
  @@map("keyword_prompts")
}

model ApiKey {
  id        String   @id @default(uuid())
  key       String   @unique
  name      String?
  createdAt DateTime @default(now())
  
  @@map("api_keys")
}
