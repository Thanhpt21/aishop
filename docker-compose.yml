version: "3.8"
services:
  api:
    build: .
    env_file:
      - .env
    ports:
      - "3000:3000"
    depends_on:
      - redis
    
    # ğŸŒŸ ÄIá»€U CHá»ˆNH QUAN TRá»ŒNG: Tá»± Ä‘á»™ng cháº¡y Prisma Migration vÃ  sau Ä‘Ã³ khá»Ÿi Ä‘á»™ng á»©ng dá»¥ng
    # Lá»‡nh nÃ y giáº£ Ä‘á»‹nh báº¡n cÃ³ script khá»Ÿi Ä‘á»™ng phÃ¡t triá»ƒn (dev) hoáº·c sáº£n xuáº¥t (prod) trong package.json
    # command: sh -c "sleep 5 && npx prisma migrate deploy && npm run start:dev"
    command: npm run start:dev
    
    # Volume mapping cho phÃ©p Prisma Client truy cáº­p thÆ° má»¥c migration.
    # HÃ£y Ä‘áº£m báº£o ráº±ng thÆ° má»¥c 'prisma' Ä‘Æ°á»£c copy vÃ o image trong Dockerfile.
    volumes:
      - ./prisma:/app/prisma 
      - ./src:/app/src
      
  redis:
    image: redis:7
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD} # Sá»­ dá»¥ng biáº¿n mÃ´i trÆ°á»ng Ä‘Ã£ Ä‘á»‹nh nghÄ©a
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data

volumes:
  redisdata: